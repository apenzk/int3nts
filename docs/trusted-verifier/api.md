# Trusted Verifier API

Base URL: `http://<host>:<port>` (defaults to `127.0.0.1:3333`)

All responses share the shape:

```json
{
  "success": true|false,
  "message": string,
  "data": <payload|null>
}
```

## GET /health

Health check.

Example

```bash
curl -s http://127.0.0.1:3333/health
```

## GET /public-key

Returns the verifier public key (base64, 32 bytes).

Response

```json
{
  "success": true,
  "data": {
    "public_key": "<base64>"
  }
}
```

## GET /events

Returns cached events observed by the monitor (intent, escrow, fulfillment) and cached approvals.

Response (abbreviated)

```json
{
  "success": true,
  "data": {
    "intent_events": [
      {
        "chain": "hub",
        "intent_id": "0x...",
        "issuer": "0x...",
        "offered_metadata": {"inner":"0xa"},
        "offered_amount": 0,
        "desired_metadata": {"inner":"0xa"},
        "desired_amount": 100000000,
        "expiry_time": 1761765097,
        "revocable": false,
        "timestamp": 1761761513
      }
    ],
    "escrow_events": [
      {
        "chain": "connected",
        "escrow_id": "0x...",
        "intent_id": "0x...",
        "issuer": "0x...",
        "offered_metadata": {"inner":"0xa"},
        "offered_amount": 1000,
        "desired_metadata": {"inner":"0xa"},
        "desired_amount": 0,
        "expiry_time": 1761765097,
        "revocable": false,
        "reserved_solver": "0x...",
        "chain_id": 2,
        "chain_type": "Mvm",
        "timestamp": 1761761513
      }
    ],
    "fulfillment_events": [ { ... } ],
    "approvals": [ { ... } ]
  }
}
```

## GET /approvals

Returns approvals generated by the verifier after observing fulfillment + matching escrow.

Response item:

```json
{
  "escrow_id": "0x...",
  "intent_id": "0x...",
  "signature": "<base64>",
  "timestamp": 1761761504
}
```

Note: The signature itself is the approval - verifier signs the `intent_id` to approve the escrow.

Example:

```bash
curl -s http://127.0.0.1:3333/approvals | jq
```

## POST /approval

Manually create an approval signature for a given `intent_id`.

Request

```json
{
  "intent_id": "0x..."
}
```

Response

```json
{
  "success": true,
  "data": {
    "signature": "<base64>",
    "timestamp": 1761761504
  }
}
```

Note: The signature itself is the approval - verifier signs the `intent_id`.

## POST /validate-outflow-fulfillment

Validates a connected chain transaction for an outflow intent and returns an approval signature if validation passes.

**Request**

```json
{
  "transaction_hash": "0x...",
  "chain_type": "mvm" | "evm",
  "intent_id": "0x..." (optional)
}
```

**Response**

```json
{
  "success": true,
  "data": {
    "validation": {
      "valid": true,
      "message": "Outflow fulfillment validation successful",
      "timestamp": 1763586708
    },
    "approval_signature": {
      "signature": "<base64>",
      "timestamp": 1763586708
    }
  }
}
```

**Usage in Outflow Fulfillment**

1) Solver transfers tokens on connected chain (includes `intent_id` in transaction)
2) Solver calls `/validate-outflow-fulfillment` with transaction hash
3) If validation passes, convert base64 signature to hex and submit hub chain entry: `fulfill_outflow_request_intent(intent, signature_hex)`

In the integration script this is automated:

```bash
# Convert base64 signature to hex (Ed25519 signature is 64 bytes = 128 hex chars)
SIGNATURE_HEX=$(echo "$APPROVAL_SIGNATURE" | base64 -d | xxd -p -c 1000 | tr -d '\n')

aptos move run --profile bob-chain1 --assume-yes \
  --function-id "0x<hub_module_address>::fa_intent_outflow::fulfill_outflow_request_intent" \
  --args "address:<intent_object_address>" "hex:<signature_hex>"
```

**Notes**

- The signature is over BCS-encoded `intent_id` (address) - the signature itself is the approval
- Signature is base64-encoded in the API response; must be converted to hex for Move function calls
- Ed25519 signatures are 64 bytes (128 hex characters)

## Usage in Escrow Release

1) Poll `/approvals` until an approval with your `escrow_id` appears
2) Submit connected‑chain entry: `complete_escrow_from_fa(escrow_id, payment_amount, signature)`

In the integration script this is automated (bob‑chain2 profile):

```bash
# Convert base64 signature to hex
SIGNATURE_HEX=$(echo "$SIGNATURE_BASE64" | base64 -d | xxd -p -c 1000 | tr -d '\n')

aptos move run --profile bob-chain2 --assume-yes \
  --function-id "0x<connected_module_address>::intent_as_escrow_entry::complete_escrow_from_fa" \
  --args "address:<escrow_id>" "u64:<payment_amount>" "hex:<signature_hex>"
```
